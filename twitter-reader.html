<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Twitter 书签查看器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* ===== 设计系统 - X.com 风格 ===== */
        :root {
            /* X.com 配色 */
            --color-bg: #f7f9f9;
            --color-surface: #ffffff;
            --color-border: #eff3f4;
            --color-border-light: #f7f9f9;

            --color-text-primary: #0f1419;
            --color-text-secondary: #536471;
            --color-text-tertiary: #8b98a5;
            --color-text-link: #1d9bf0;

            --color-hover: #f7f9f9;
            --color-hover-dark: #e7e9ea;

            --color-success: #00be4f;
            --color-success-bg: #e8f9ed;
            --color-warning: #ffad1f;
            --color-warning-bg: #fff8e8;
            --color-danger: #f4212e;
            --color-danger-bg: #ffe9e9;

            /* 圆角 - X 使用更大的圆角 */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            /* 过渡 */
            --transition-fast: 100ms ease;
            --transition-normal: 200ms ease;
        }

        /* ===== 基础重置 ===== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--color-bg);
            color: var(--color-text-primary);
            line-height: 1.4;
            min-height: 100vh;
            padding: 24px 16px;
        }

        /* ===== 布局容器 ===== */
        .container {
            max-width: 1260px;
            margin: 0 auto;
        }

        /* ===== 头部区域 - X 风格简洁头部 ===== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--color-border);
        }

        .header-main {
            flex: 1;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: 6px;
        }

        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .stats-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats-num {
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        /* ===== 导入按钮 - X 风格实心黑按钮 ===== */
        .upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--color-text-primary);
            color: var(--color-surface);
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all var(--transition-fast);
        }

        .upload-btn:hover {
            background: #333;
        }

        .upload-btn svg {
            width: 18px;
            height: 18px;
        }

        /* 拖放状态 */
        .upload-btn.drag-over {
            background: var(--color-text-link);
        }

        /* ===== 搜索框 - X pill 形状 ===== */
        .search-box {
            margin-bottom: 16px;
        }

        .search-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .search-row input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            font-size: 15px;
            color: var(--color-text-primary);
            background: var(--color-surface);
            outline: none;
            transition: all var(--transition-fast);
        }

        .search-row input::placeholder {
            color: var(--color-text-tertiary);
        }

        .search-row input:focus {
            border-color: var(--color-text-link);
        }

        #authorSearchInput {
            flex: 0 0 180px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            font-size: 15px;
            color: var(--color-text-primary);
            background: var(--color-surface);
            outline: none;
            transition: all var(--transition-fast);
        }

        .search-box input::placeholder {
            color: var(--color-text-tertiary);
        }

        .search-box input:focus {
            border-color: var(--color-text-link);
            background: var(--color-surface);
        }

        /* ===== 表格容器 - X 风格简洁表格 ===== */
        .table-wrapper {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--color-surface);
        }

        th {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text-secondary);
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-border);
            vertical-align: middle;
            background: var(--color-surface);
        }

        tbody tr {
            transition: background var(--transition-fast);
        }

        tbody tr.clickable {
            cursor: pointer;
        }

        tbody tr.clickable:hover td {
            background: var(--color-hover) !important;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* ===== 头像 - X 圆角方形 ===== */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            object-fit: cover;
        }

        /* ===== 用户信息 ===== */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-names {
            line-height: 1.3;
        }

        .user-names strong {
            font-weight: 600;
            color: var(--color-text-primary);
            font-size: 14px;
        }

        .username {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        /* ===== 内容列 ===== */
        .content {
            max-width: 360px;
            font-size: 14px;
            line-height: 1.5;
            color: var(--color-text-primary);
        }

        .content a {
            color: var(--color-text-link);
            text-decoration: none;
        }

        .content a:hover {
            text-decoration: underline;
        }

        .content img {
            display: block;
            max-width: 100px;
            max-height: 60px;
            border-radius: var(--radius-sm);
            margin-top: 8px;
            cursor: pointer;
        }

        /* ===== 媒体标签 ===== */
        .media-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 22px;
            height: 22px;
            padding: 0 8px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 500;
            margin-right: 6px;
        }

        .media-image {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .media-video {
            background: var(--color-warning-bg);
            color: #d48806;
        }

        .media-gif {
            background: #f3e8ff;
            color: #8b5cf6;
        }

        .media-link {
            background: rgba(29, 155, 240, 0.1);
            color: var(--color-text-link);
        }

        /* ===== 时间 ===== */
        .time {
            font-size: 13px;
            color: var(--color-text-secondary);
            white-space: nowrap;
        }

        /* ===== 互动数据 ===== */
        .engagement {
            display: flex;
            gap: 14px;
        }

        .engagement-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .engagement-item svg {
            width: 16px;
            height: 16px;
        }

        .engagement-item.likes {
            color: #f91880;
        }

        .engagement-item.retweets {
            color: var(--color-success);
        }

        /* ===== 操作按钮 ===== */
        .actions a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            background: var(--color-text-primary);
            color: var(--color-surface);
            border: none;
            border-radius: var(--radius-full);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            transition: all var(--transition-fast);
        }

        .actions a:hover {
            background: #333;
        }

        /* ===== 状态标签 ===== */
        .cache-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--color-success-bg);
            color: var(--color-success);
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 500;
        }

        .cache-status.error {
            background: var(--color-danger-bg);
            color: var(--color-danger);
        }

        /* ===== 清空缓存按钮 ===== */
        .clear-cache {
            padding: 6px 12px;
            background: transparent;
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .clear-cache:hover {
            background: var(--color-danger-bg);
            color: var(--color-danger);
            border-color: var(--color-danger);
        }

        /* ===== 空状态 ===== */
        .empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-tertiary);
        }

        .empty-icon {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* ===== 加载状态 ===== */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-text-link);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== 分页 - X 简洁风格 ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            padding: 16px;
        }

        .pagination button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text-primary);
            transition: all var(--transition-fast);
        }

        .pagination button svg {
            width: 16px;
            height: 16px;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--color-hover);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            margin: 0 12px;
            padding: 0 12px;
            font-size: 13px;
            color: var(--color-text-secondary);
            white-space: nowrap;
        }

        .pagination .page-numbers {
            display: flex;
            gap: 4px;
        }

        .pagination .page-num {
            min-width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text-primary);
            transition: all var(--transition-fast);
        }

        .pagination .page-num:hover {
            background: var(--color-hover);
        }

        .pagination .page-num.active {
            background: var(--color-text-primary);
            color: var(--color-surface);
        }

        .pagination .page-size {
            margin-left: 12px;
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            font-size: 13px;
            background: var(--color-surface);
            color: var(--color-text-primary);
            outline: none;
            cursor: pointer;
        }

        .pagination .page-size:focus {
            border-color: var(--color-text-link);
        }

        /* ===== 拖放覆盖层 ===== */
        .drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            border: 2px dashed var(--color-text-link);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .drop-overlay.active {
            display: flex;
        }

        .drop-overlay-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text-link);
            padding: 24px 40px;
            background: rgba(29, 155, 240, 0.1);
            border-radius: var(--radius-lg);
        }

        /* ===== Dialog 弹窗样式 ===== */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .dialog-overlay.active {
            display: flex;
        }

        .dialog {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .dialog-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            background: var(--color-surface);
            z-index: 1;
        }

        .dialog-user {
            display: flex;
            gap: 12px;
            cursor: pointer;
            padding: 4px;
            margin: -4px;
            border-radius: var(--radius-md);
            transition: background var(--transition-fast);
        }

        .dialog-user:hover {
            background: var(--color-hover);
        }

        .dialog-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
        }

        .dialog-user-info {
            line-height: 1.4;
        }

        .dialog-user-info strong {
            font-weight: 600;
            font-size: 15px;
            color: var(--color-text-primary);
        }

        .dialog-user-info .username {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .dialog-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }

        .dialog-close:hover {
            background: var(--color-hover);
            color: var(--color-text-primary);
        }

        .dialog-close svg {
            width: 20px;
            height: 20px;
            display: block;
        }

        .dialog-body {
            padding: 20px;
        }

        .dialog-content {
            font-size: 15px;
            line-height: 1.6;
            color: var(--color-text-primary);
            margin-bottom: 16px;
            word-break: break-word;
        }

        .dialog-content a {
            color: var(--color-text-link);
            word-break: break-all;
        }

        .dialog-media {
            margin-top: 12px;
        }

        .dialog-media img,
        .dialog-media video {
            max-width: 100%;
            border-radius: var(--radius-md);
            margin-top: 8px;
        }

        .dialog-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--color-border);
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .dialog-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dialog-meta-item svg {
            width: 16px;
            height: 16px;
        }

        .dialog-actions {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            border-top: 1px solid var(--color-border);
            background: var(--color-bg);
        }

        .dialog-actions a {
            flex: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            background: var(--color-text-primary);
            color: var(--color-surface);
            border: none;
            border-radius: var(--radius-full);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .dialog-actions a:hover {
            background: #333;
        }

        .dialog-actions a.secondary {
            background: transparent;
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }

        .dialog-actions a.secondary:hover {
            background: var(--color-hover);
        }

        /* ===== 响应式 ===== */
        @media (max-width: 1024px) {
            .content {
                max-width: 280px;
            }
        }

        /* ===== Tab 导航 ===== */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: var(--color-surface);
            padding: 4px;
            border-radius: var(--radius-full);
            width: fit-content;
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text-secondary);
            transition: all var(--transition-fast);
        }

        .tab:hover {
            color: var(--color-text-primary);
            background: var(--color-hover);
        }

        .tab.active {
            background: var(--color-text-primary);
            color: var(--color-surface);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .list-container.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tab 导航 -->
        <div class="tabs">
            <button class="tab active" data-tab="list" onclick="switchTab('list')">书签列表</button>
        </div>

        <!-- 列表视图 -->
        <div class="tab-content list-container active" id="listTab">
            <div class="header">
                <div class="header-main">
                    <h1>Twitter 书签</h1>
                    <div class="stats" id="stats">
                        <span>等待导入数据...</span>
                    </div>
                </div>
                <div class="header-actions">
                    <label class="upload-btn" for="fileInput" style="cursor:pointer;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        导入数据
                    </label>
                    <input type="file" id="fileInput" accept=".json,.jsonl" style="display:none">
                </div>
            </div>
            <div class="search-row">
                <input type="text" id="searchInput" placeholder="搜索推文内容或作者...">
                <label style="display:flex;align-items:center;gap:8px;font-size:14px;color:var(--color-text-secondary);cursor:pointer;">
                    <input type="checkbox" id="authorOnlyCheck" onchange="applyFilters()" style="width:18px;height:18px;cursor:pointer;">
                    仅检索作者
                </label>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th style="width:48px"></th>
                            <th style="width:140px">用户</th>
                            <th>内容</th>
                            <th style="width:80px">媒体</th>
                            <th style="width:90px">时间</th>
                            <th style="width:80px">互动</th>
                            <th style="width:60px"></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="pagination" style="display:none;">
                <button id="prevBtn" onclick="prevPage()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                </button>
                <div class="page-numbers" id="pageNumbers"></div>
                <button id="nextBtn" onclick="nextPage()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </button>
                <span class="page-info" id="pageInfo"></span>
                <select class="page-size" id="pageSize" onchange="changePageSize()">
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
    </div>

    <!-- 拖放覆盖层 -->
    <div class="drop-overlay" id="dropOverlay">
        <div class="drop-overlay-text">拖放文件到此处导入</div>
    </div>

    <!-- 详情弹窗 -->
    <div class="dialog-overlay" id="dialogOverlay">
        <div class="dialog" id="dialog">
            <div class="dialog-header">
                <div class="dialog-user" id="dialogUserArea" onclick="filterByAuthor()">
                    <img class="dialog-avatar" id="dialogAvatar" src="" alt="头像">
                    <div class="dialog-user-info">
                        <strong id="dialogUsername"></strong>
                        <div class="username" id="dialogScreenName"></div>
                    </div>
                </div>
                <button class="dialog-close" onclick="closeDialog()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="dialog-body">
                <div class="dialog-content" id="dialogContent"></div>
                <div class="dialog-media" id="dialogMedia"></div>
                <div class="dialog-meta">
                    <span class="dialog-meta-item" id="dialogTime">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                    </span>
                    <span class="dialog-meta-item" id="dialogLikes">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                    </span>
                    <span class="dialog-meta-item" id="dialogRetweets">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
                        </svg>
                    </span>
                </div>
            </div>
            <div class="dialog-actions">
                <a id="dialogViewOriginal" href="#" target="_blank">查看原帖</a>
                <a id="dialogCopyLink" class="secondary" onclick="copyTweetLink()">复制链接</a>
                <a id="dialogExportImage" class="secondary" onclick="exportDialogImage()">导出图片</a>
            </div>
        </div>
    </div>

    <script>
        let tweets = [];
        let filteredTweets = [];
        let currentPage = 1;
        let pageSize = 20;
        let db = null;
        const DB_NAME = 'TwitterBookmarkDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'tweets';

        // 打开 IndexedDB
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'tweet_id' });
                    }
                };
            });
        }

        // 保存数据到 IndexedDB
        async function saveTweets(data) {
            return new Promise(async (resolve, reject) => {
                try {
                    if (!db) await openDB();

                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);

                    // 先清空旧数据
                    store.clear();

                    // 保存新数据
                    data.forEach(item => store.put(item));

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // 从 IndexedDB 读取数据
        async function loadTweets() {
            return new Promise(async (resolve, reject) => {
                try {
                    if (!db) await openDB();

                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // 清空缓存
        async function clearCache() {
            return new Promise(async (resolve, reject) => {
                try {
                    if (!db) await openDB();

                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.clear();

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // 跳转到指定页
        function goToPage(page) {
            const totalPages = Math.ceil(filteredTweets.length / pageSize);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
            renderPagination();
        }

        // 上一页
        function prevPage() {
            goToPage(currentPage - 1);
        }

        // 下一页
        function nextPage() {
            goToPage(currentPage + 1);
        }

        // 切换每页数量
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            renderTable();
            renderPagination();
        }

        // 渲染分页控件
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageNumbers = document.getElementById('pageNumbers');
            const pageInfo = document.getElementById('pageInfo');

            if (filteredTweets.length === 0) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            const totalPages = Math.ceil(filteredTweets.length / pageSize);
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, filteredTweets.length);

            pageInfo.textContent = `显示 ${start}-${end} 条，共 ${filteredTweets.length} 条`;

            // 渲染页码：当前页, 当前页+1, ..., 最大页-1, 最大页
            let pagesHtml = '';
            const maxVisiblePages = 5;

            if (totalPages <= maxVisiblePages) {
                for (let i = 1; i <= totalPages; i++) {
                    const activeClass = i === currentPage ? 'active' : '';
                    pagesHtml += `<button class="page-num ${activeClass}" onclick="goToPage(${i})">${i}</button>`;
                }
            } else {
                // 始终显示当前页（高亮）
                pagesHtml += `<button class="page-num active" onclick="goToPage(${currentPage})">${currentPage}</button>`;

                // 当前页+1 (不超过最大页)
                if (currentPage + 1 < totalPages) {
                    pagesHtml += `<button class="page-num" onclick="goToPage(${currentPage + 1})">${currentPage + 1}</button>`;
                }

                // 省略号 (当前页+1 与 最大页-1 之间有间隔)
                if (currentPage + 1 < totalPages - 2) {
                    pagesHtml += `<span class="page-num" style="border:none;cursor:default;">...</span>`;
                }

                // 最大页-1
                if (currentPage < totalPages - 1) {
                    pagesHtml += `<button class="page-num" onclick="goToPage(${totalPages - 1})">${totalPages - 1}</button>`;
                }

                // 始终显示最大页
                pagesHtml += `<button class="page-num" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            pageNumbers.innerHTML = pagesHtml;

            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        function renderStats() {
            const stats = document.getElementById('stats');
            const total = tweets.length;
            const withImage = tweets.filter(t => t.has_image).length;
            const withVideo = tweets.filter(t => t.has_video).length;
            const withLink = tweets.filter(t => t.has_link).length;

            stats.innerHTML = `
                <span>共 <strong class="stats-num">${total}</strong> 条推文</span>
                <span>图片 <strong class="stats-num">${withImage}</strong></span>
                <span>视频 <strong class="stats-num">${withVideo}</strong></span>
                <span>链接 <strong class="stats-num">${withLink}</strong></span>
            `;
        }

        // ========== Tab 切换 ==========
        function switchTab(tabName) {
            // 更新 tab 按钮状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // 更新内容显示
            document.getElementById('listTab').classList.toggle('active', tabName === 'list');
            document.getElementById('listTab').classList.toggle('list-container', tabName === 'list');
        }

        // 格式化时间
        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return '刚刚';
            if (diff < 3600000) return Math.floor(diff / 60000) + '分钟前';
            if (diff < 86400000) return Math.floor(diff / 3600000) + '小时前';
            if (diff < 2592000000) return Math.floor(diff / 86400000) + '天前';

            return date.toLocaleDateString('zh-CN');
        }

        // 完整格式化时间
        function formatFullTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 截断文本，超长时显示省略号
        function truncateText(text, maxLength = 120) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // 格式化推文内容，将 URL 转换为可点击链接
        function formatContent(text, tweet) {
            // 先截断纯文本部分
            let html = truncateText(text).replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // 替换 URL 为可点击链接
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            html = html.replace(urlRegex, url => {
                let displayUrl = url;
                if (url.includes('t.co') || url.includes('x.com/i/communities')) {
                    displayUrl = url;
                } else if (url.length > 40) {
                    displayUrl = url.substring(0, 40) + '...';
                }
                return `<a href="${url}" target="_blank">${displayUrl}</a>`;
            });

            // 显示第一张图片缩略图
            if (tweet.media_items && tweet.media_items.length > 0) {
                const firstMedia = tweet.media_items[0];
                if (firstMedia.media_url_https) {
                    html += `<br><img src="${firstMedia.media_url_https}" alt="预览图" onclick="event.stopPropagation(); window.open('${firstMedia.expanded_url}', '_blank')">`;
                }
            }

            return html;
        }

        // 完整格式化推文内容（dialog 使用）
        function formatFullContent(text, tweet) {
            let html = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // 支持换行显示
            html = html.replace(/\n/g, '<br>');

            // 替换 URL 为可点击链接
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            html = html.replace(urlRegex, url => {
                let displayUrl = url;
                if (url.includes('t.co') || url.includes('x.com/i/communities')) {
                    displayUrl = url;
                } else if (url.length > 60) {
                    displayUrl = url.substring(0, 60) + '...';
                }
                return `<a href="${url}" target="_blank">${displayUrl}</a>`;
            });

            // 显示所有图片
            if (tweet.media_items && tweet.media_items.length > 0) {
                html += '<div class="dialog-media">';
                tweet.media_items.forEach(media => {
                    if (media.media_url_https) {
                        if (media.type === 'video' || media.type === 'animated_gif') {
                            html += `<video src="${media.video_info?.variants?.[0]?.url || media.media_url_https}" controls poster="${media.media_url_https}"></video>`;
                        } else {
                            html += `<img src="${media.media_url_https}" alt="媒体" onclick="window.open('${media.expanded_url}', '_blank')">`;
                        }
                    }
                });
                html += '</div>';
            }

            return html;
        }

        // 获取媒体类型标签
        function getMediaBadge(tweet) {
            const badges = [];
            if (tweet.has_image) badges.push('<span class="media-badge media-image">图</span>');
            if (tweet.has_video) badges.push('<span class="media-badge media-video">视频</span>');
            if (tweet.has_gif) badges.push('<span class="media-badge media-gif">GIF</span>');
            if (tweet.has_link) badges.push('<span class="media-badge media-link">链</span>');
            return badges.join('');
        }

        // 打开详情弹窗
        let currentDialogScreenName = null;

        function openDialog(tweet) {
            currentDialogScreenName = tweet.screen_name;
            document.getElementById('dialogAvatar').src = tweet.avatar_url || '';
            document.getElementById('dialogUsername').textContent = tweet.username || '';
            document.getElementById('dialogScreenName').textContent = '@' + (tweet.screen_name || '');
            document.getElementById('dialogContent').innerHTML = formatFullContent(tweet.full_text || '', tweet);
            document.getElementById('dialogTime').innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                ${formatFullTime(tweet.created_at || 0)}
            `;
            document.getElementById('dialogLikes').innerHTML = `
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
                ${tweet.favorite_count || 0}
            `;
            document.getElementById('dialogRetweets').innerHTML = `
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
                </svg>
                ${tweet.retweet_count || 0}
            `;
            document.getElementById('dialogViewOriginal').href = `https://x.com/${tweet.screen_name}/status/${tweet.tweet_id}`;
            document.getElementById('dialog').dataset.tweetId = tweet.tweet_id;
            document.getElementById('dialogOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // 关闭详情弹窗
        function closeDialog() {
            document.getElementById('dialogOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // 点击作者过滤该作者的所有推文
        function filterByAuthor() {
            if (!currentDialogScreenName) return;
            document.getElementById('searchInput').value = '@' + currentDialogScreenName;
            document.getElementById('authorOnlyCheck').checked = true;
            closeDialog();
            applyFilters();
        }

        // 复制推文链接
        function copyTweetLink() {
            const url = document.getElementById('dialogViewOriginal').href;
            navigator.clipboard.writeText(url).then(() => {
                const btn = document.getElementById('dialogCopyLink');
                const originalText = btn.textContent;
                btn.textContent = '已复制';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        // 导出弹窗图片
        async function exportDialogImage() {
            const dialog = document.getElementById('dialog');
            const btn = document.getElementById('dialogExportImage');
            const originalText = btn.textContent;
            btn.textContent = '生成中...';

            // 临时禁用 sticky 和滚动，捕获完整内容
            const header = dialog.querySelector('.dialog-header');
            const actions = dialog.querySelector('.dialog-actions');
            const body = dialog.querySelector('.dialog-body');

            const originalPosition = header.style.position;
            const originalTop = header.style.top;
            const originalZIndex = header.style.zIndex;
            const originalOverflowY = dialog.style.overflowY;
            const originalMaxHeight = dialog.style.maxHeight;

            // 禁用 sticky，让头部正常参与布局
            header.style.position = 'relative';
            header.style.top = '0';
            header.style.zIndex = '0';

            // 临时展开完整高度
            dialog.style.overflowY = 'visible';
            dialog.style.maxHeight = 'none';

            // 强制重排
            await new Promise(resolve => setTimeout(resolve, 50));
            dialog.offsetHeight;

            try {
                const canvas = await html2canvas(dialog, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true
                });

                const link = document.createElement('a');
                const tweetId = dialog.dataset.tweetId || 'unknown';
                const timestamp = Date.now();
                link.download = `tweet_${tweetId}_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                btn.textContent = '已导出';
            } catch (error) {
                console.error('导出失败:', error);
                btn.textContent = '导出失败';
            } finally {
                // 恢复样式
                header.style.position = originalPosition;
                header.style.top = originalTop;
                header.style.zIndex = originalZIndex;
                dialog.style.overflowY = originalOverflowY;
                dialog.style.maxHeight = originalMaxHeight;
            }

            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }

        // 点击遮罩层关闭弹窗
        document.getElementById('dialogOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDialog();
            }
        });

        // ESC 键关闭弹窗
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDialog();
            }
        });

        // 渲染表格
        function renderTable() {
            const tableBody = document.getElementById('tableBody');

            if (filteredTweets.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="empty"><div class="empty-icon">&#x1F50D;</div><p>没有找到匹配的推文</p></td></tr>';
                return;
            }

            // 只渲染当前页的数据
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = filteredTweets.slice(start, end);

            tableBody.innerHTML = pageData.map(tweet => `
                <tr class="clickable" onclick='openDialog(${JSON.stringify(tweet).replace(/'/g, "&#39;")})'>
                    <td>
                        <img class="avatar" src="${tweet.avatar_url || ''}" alt="头像">
                    </td>
                    <td>
                        <div class="user-info">
                            <div class="user-names">
                                <div><strong>${tweet.username || ''}</strong></div>
                                <div class="username">@${tweet.screen_name || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="content">${formatContent(tweet.full_text || '', tweet)}</td>
                    <td>${getMediaBadge(tweet)}</td>
                    <td class="time">${formatTime(tweet.created_at || 0)}</td>
                    <td>
                        <div class="engagement">
                            <span class="engagement-item likes">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                                ${tweet.favorite_count || 0}
                            </span>
                            <span class="engagement-item retweets">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
                                </svg>
                                ${tweet.retweet_count || 0}
                            </span>
                        </div>
                    </td>
                    <td class="actions">
                        <a href="https://x.com/${tweet.screen_name}/status/${tweet.tweet_id}" target="_blank" onclick="event.stopPropagation()">查看</a>
                    </td>
                </tr>
            `).join('');
        }

        // 搜索功能
        let searchTimeout = null;

        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 150);
        });

        // 综合筛选函数
        function applyFilters() {
            const searchInput = document.getElementById('searchInput');
            const authorOnlyCheck = document.getElementById('authorOnlyCheck');
            const query = searchInput.value.trim().toLowerCase();
            // 去掉 @ 符号，因为 screen_name 不存储 @
            const cleanQuery = query.replace('@', '');
            const authorOnly = authorOnlyCheck.checked;

            filteredTweets = tweets.filter(tweet => {
                if (!cleanQuery) return true;

                const username = (tweet.username || '').toLowerCase();
                const screenName = (tweet.screen_name || '').toLowerCase();

                if (authorOnly) {
                    // 仅检索作者
                    return username.includes(cleanQuery) || screenName.includes(cleanQuery);
                } else {
                    // 检索内容 + 作者
                    const text = (tweet.full_text || '').toLowerCase();
                    return text.includes(cleanQuery) || username.includes(cleanQuery) || screenName.includes(cleanQuery);
                }
            });

            currentPage = 1;
            renderTable();
            renderPagination();
        }

        // 页面加载时尝试读取缓存
        async function initFromCache() {
            try {
                const cachedTweets = await loadTweets();
                if (cachedTweets && cachedTweets.length > 0) {
                    // 按 sort_index 倒序排序（Twitter 书签导出数据的时间倒序标识）
                    const sortByTime = (a, b) => {
                        const sortA = BigInt(a.sort_index || 0);
                        const sortB = BigInt(b.sort_index || 0);
                        if (sortB > sortA) return 1;
                        if (sortB < sortA) return -1;
                        return 0;
                    };

                    tweets = cachedTweets.sort(sortByTime);
                    filteredTweets = [...tweets];
                    currentPage = 1;
                    renderStats();
                    renderTable();
                    renderPagination();
                    showCacheStatus(true, `已加载缓存 (${cachedTweets.length} 条)`);
                } else {
                    document.getElementById('stats').innerHTML = '<span>等待导入数据...</span>';
                }
            } catch (error) {
                showCacheStatus(false, '加载缓存失败');
                console.error('加载缓存失败:', error);
            }
        }

        // 显示缓存状态
        function showCacheStatus(success, message) {
            const stats = document.getElementById('stats');
            stats.innerHTML = success
                ? `<span>${message}</span> <span class="cache-status">已缓存</span> <button class="clear-cache" onclick="handleClearCache()">清空</button>`
                : `<span>${message}</span> <span class="cache-status error">缓存异常</span>`;
        }

        // 处理清空缓存
        async function handleClearCache() {
            try {
                await clearCache();
                tweets = [];
                filteredTweets = [];
                currentPage = 1;
                document.getElementById('stats').innerHTML = '<span>等待导入数据...</span>';
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="empty"><div class="empty-icon">&#x2715;</div><p>缓存已清空，请重新导入</p></td></tr>';
                document.getElementById('pagination').style.display = 'none';
                // 清空热力图
                document.getElementById('heatmapTotal').textContent = '0';
                document.getElementById('heatmapGrid').innerHTML = '';
                document.getElementById('heatmapMonths').innerHTML = '';
                document.getElementById('activeDaysValue').textContent = '0';
                document.getElementById('activeDaysProgress').style.strokeDashoffset = '201.06';
                document.getElementById('streakValue').textContent = '0';
                document.getElementById('streakProgress').style.strokeDashoffset = '201.06';
                document.getElementById('weekendPercent').textContent = '0%';
                document.getElementById('peakDayCount').textContent = '0';
                document.getElementById('peakDayDate').textContent = '-';
            } catch (error) {
                alert('清空缓存失败: ' + error.message);
            }
        }

        // 文件导入功能（点击按钮）
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        // 初始化
        initFromCache();

        // ========== 拖放功能 ==========
        const dropOverlay = document.getElementById('dropOverlay');
        const uploadBtn = document.querySelector('.upload-btn');

        // 触摸设备检测：禁用拖放覆盖层（触摸设备不支持 drag/drop）
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        if (isTouchDevice) {
            dropOverlay.style.display = 'none';
        }

        let dragCount = 0;

        // 阻止默认拖放行为，并管理覆盖层显示
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropOverlay.classList.add('active');
        });

        document.addEventListener('dragenter', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dragCount++;
            dropOverlay.classList.add('active');
        });

        document.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dragCount--;
            // 只有当完全离开文档时才隐藏
            if (dragCount <= 0) {
                dropOverlay.classList.remove('active');
                dragCount = 0;
            }
        });

        document.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();

            // 隐藏覆盖层
            dropOverlay.classList.remove('active');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // 按钮上的拖放样式
        uploadBtn.addEventListener('dragenter', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadBtn.classList.add('drag-over');
        });

        uploadBtn.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadBtn.classList.add('drag-over');
        });

        uploadBtn.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadBtn.classList.remove('drag-over');
        });

        uploadBtn.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadBtn.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // 处理文件
        function handleFile(file) {
            // 立即隐藏覆盖层
            dropOverlay.classList.remove('active');
            dragCount = 0;

            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td colspan="7" class="loading"><div class="loading-spinner"></div><p>解析中...</p></td></tr>';

            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const text = event.target.result;
                    const lines = text.trim().split('\n');

                    tweets = lines.map(line => {
                        try {
                            return JSON.parse(line);
                        } catch {
                            return null;
                        }
                    }).filter(Boolean);

                    if (tweets.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="empty"><div class="empty-icon">&#x1F4C4;</div><p>文件中没有有效的推文数据</p></td></tr>';
                        return;
                    }

                    // 保存到 IndexedDB
                    await saveTweets(tweets);

                    // 按 sort_index 倒序排序（Twitter 书签导出数据的时间倒序标识）
                    const sortByTime = (a, b) => {
                        const sortA = BigInt(a.sort_index || 0);
                        const sortB = BigInt(b.sort_index || 0);
                        // 降序：大的在前（更新的在前面）
                        if (sortB > sortA) return 1;
                        if (sortB < sortA) return -1;
                        return 0;
                    };

                    filteredTweets = [...tweets].sort(sortByTime);
                    currentPage = 1;
                    renderStats();
                    renderTable();
                    renderPagination();
                    showCacheStatus(true, `已加载 ${tweets.length} 条`);
                } catch (error) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="empty"><div class="empty-icon">&#x26A0;</div><p>解析失败</p></td></tr>';
                }
            };
            reader.onerror = function() {
                tableBody.innerHTML = '<tr><td colspan="7" class="empty"><div class="empty-icon">&#x2715;</div><p>读取文件失败</p></td></tr>';
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
